<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flex Me - Login</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
  />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap");

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Quicksand", sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #222;
      width: 100%;
      overflow: hidden;
      flex-direction: column;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .light-theme {
      background: #f0f0f0;
      color: #111;
    }

    .website-name {
      font-size: 3em;
      color: #fff;
      text-align: center;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 20px;
      position: relative;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .light-theme .website-name {
      color: #111;
    }

    .website-name span {
      background: linear-gradient(45deg, #ff357a, #fff172);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: none;
      position: relative;
    }

    .website-name span::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 2px;
      background: linear-gradient(45deg, #ff357a, #fff172);
      bottom: -5px;
      left: 0;
      border-radius: 2px;
    }

    .toggle-container {
      position: absolute;
      bottom: 20px;
      left: 20px;
    }

    .toggle {
      width: 50px;
      height: 25px;
      background: #ccc;
      border-radius: 25px;
      position: relative;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle::before {
      content: "";
      position: absolute;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s ease;
    }

    .toggle.active {
      background: #4caf50;
    }

    .toggle.active::before {
      transform: translateX(25px);
    }

    .ring {
      position: relative;
      width: 500px;
      height: 500px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .ring i {
      position: absolute;
      inset: 0;
      border: 2px solid #fff;
      transition: 0.5s;
    }

    .ring i:nth-child(1) {
      border-radius: 38% 62% 63% 37% / 41% 44% 56% 59%;
      animation: animate 6s linear infinite;
    }

    .ring i:nth-child(2) {
      border-radius: 41% 44% 56% 59% / 38% 62% 63% 37%;
      animation: animate 4s linear infinite;
    }

    .ring i:nth-child(3) {
      border-radius: 41% 44% 56% 59% / 38% 62% 63% 37%;
      animation: animate2 10s linear infinite;
    }

    .ring:hover i {
      border: 6px solid var(--clr);
      filter: drop-shadow(0 0 20px var(--clr));
    }

    @keyframes animate {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes animate2 {
      0% {
        transform: rotate(360deg);
      }
      100% {
        transform: rotate(0deg);
      }
    }

    .login {
      position: absolute;
      width: 300px;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 20px;
    }

    .login h2 {
      font-size: 2em;
      color: #fff;
    }

    .light-theme .login h2 {
      color: #111;
    }

    .login .inputBx {
      position: relative;
      width: 100%;
    }

    .login .inputBx input {
      position: relative;
      width: 100%;
      padding: 12px 20px;
      background: transparent;
      border: 2px solid #fff;
      border-radius: 40px;
      font-size: 1.2em;
      color: #fff;
      box-shadow: none;
      outline: none;
      transition: 0.5s;
    }

    .light-theme .login .inputBx input {
      border: 2px solid #111;
      color: #111;
      background: rgba(255, 255, 255, 0.9);
    }

    .login .inputBx input:hover,
    .login .inputBx input:focus {
      border-color: var(--clr, #0078ff);
      box-shadow: 0 0 10px var(--clr, #0078ff);
    }

    .login .inputBx input[type="submit"] {
      width: 100%;
      background: linear-gradient(45deg, #ff357a, #fff172);
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .login .inputBx input[type="submit"]:hover {
      background: linear-gradient(45deg, #fff172, #ff357a);
    }

    .login .inputBx input::placeholder {
      color: rgba(255, 255, 255, 0.75);
    }

    .light-theme .login .inputBx input::placeholder {
      color: rgba(0, 0, 0, 0.5);
    }

    .login .links {
      position: relative;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .login .links a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: 0.5s;
    }

    .light-theme .login .links a {
      color: #111;
    }

    .login .links a:hover {
      color: var(--clr, #0078ff);
      text-shadow: 0 0 10px var(--clr, #0078ff);
    }

    .error-message {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      text-align: center;
    }

    footer {
      margin-top: auto;
      padding: 1rem;
      color: #fff;
      text-align: center;
      width: 100%;
      background: rgba(17, 17, 17, 0.95);
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      margin-bottom: 20px;
      padding: 10px 20px;
    }

    .navbar-nav {
      position: absolute;
      left: 20px;
      display: flex;
      gap: 20px;
    }

    .nav-link {
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }

    .nav-link:hover {
      color: #ff357a;
    }

    /* Password Recovery Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal-content {
        position: relative;
        background: linear-gradient(145deg, #2a2a2a, #3a3a3a);
        margin: 15% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        animation: slideIn 0.3s ease;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-content h2 {
        color: #fff;
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.8em;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .close-modal {
        position: absolute;
        right: 20px;
        top: 15px;
        font-size: 24px;
        cursor: pointer;
        color: #fff;
        background: none;
        border: none;
        transition: color 0.3s ease;
        opacity: 0.7;
    }

    .close-modal:hover {
        color: #ff357a;
        opacity: 1;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #fff;
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        color: #fff;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: #ff357a;
        box-shadow: 0 0 10px rgba(255, 53, 122, 0.3);
    }

    .security-question {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-style: italic;
        border-left: 3px solid #ff357a;
    }

    .attempts-counter {
        text-align: center;
        margin-top: 10px;
        color: #ff9999;
        font-size: 0.9em;
    }

    .error-message {
        background: rgba(255, 68, 68, 0.1);
        color: #ff4444;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid rgba(255, 68, 68, 0.3);
        display: none;
    }

    .success-message {
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin: 20px 0;
    }

    .success-message i {
        font-size: 48px;
        color: #4CAF50;
        margin-bottom: 15px;
    }

    .success-message p {
        margin: 10px 0;
        color: #fff;
    }

    #recoveredPassword {
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 1.2em;
        letter-spacing: 1px;
        margin: 10px 0;
    }

    .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(45deg, #ff357a, #fff172);
        color: #fff;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .btn:hover {
        background: linear-gradient(45deg, #fff172, #ff357a);
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(255, 53, 122, 0.3);
    }

    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { 
            transform: translateY(-30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Light theme adjustments for modal */
    .light-theme .modal-content {
        background: #fff;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .light-theme .modal h2 {
        color: #333;
    }

    .light-theme .form-group label {
        color: #555;
    }

    .light-theme .password-display {
        background: #f0f0f0;
    }

    @media (max-width: 500px) {
      .ring {
        width: 300px;
        height: 300px;
      }

      .website-name {
        font-size: 2em;
      }

      .login {
        width: 250px;
      }

      .login h2 {
        font-size: 1.5em;
      }

      .login .inputBx input {
        font-size: 1em;
        padding: 10px 15px;
      }
    }

    .error-message {
      display: none;
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      text-align: center;
    }

    .form-check {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
    }

    .form-check label {
      margin: 0;
      cursor: pointer;
    }

    .password-container {
      position: relative;
    }

    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #666;
    }

    .login-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 15px 0;
    }

    .forgot-password {
      color: var(--primary);
      text-decoration: none;
    }

    .forgot-password:hover {
      text-decoration: underline;
    }

    .social-login {
      margin-top: 20px;
      text-align: center;
    }

    .social-login .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
    }

    .social-login .divider::before,
    .social-login .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .social-login .divider span {
      padding: 0 10px;
      color: #888;
    }

    .social-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .social-button {
      padding: 10px 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      background: transparent;
      color: var(--light);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .social-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .social-button i {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-nav">
      <a class="nav-link" href="home.html">Home</a>
      <a class="nav-link" href="about.html">About Us</a>
      <a class="nav-link" href="contact.html">Contact Us</a>
    </div>
    <h1 class="website-name">Flex <span>Me</span></h1>
  </nav>

  <div class="ring">
    <i style="--clr:#00ff0a;"></i>
    <i style="--clr:#ff0057;"></i>
    <i style="--clr:#fffd44;"></i>
    <div class="login">
      <h2>Login</h2>
      <div id="errorMessage" class="error-message"></div>
      <div class="inputBx">
        <input type="text" id="email" placeholder="Email" />
      </div>
      <div class="inputBx">
        <input type="password" id="password" placeholder="Password" />
      </div>
      <div class="inputBx">
        <input type="submit" value="Sign in" onClick="login()" />
      </div>
      <div class="links">
        <a href="#" class="forgot-password">Forgot Password?</a>
        <a href="register.html">Sign up</a>
      </div>
    </div>
  </div>

  <!-- Password Recovery Modal -->
  <div id="recoveryModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Password Recovery</h2>
      <div id="recoveryError" class="error-message"></div>
      <form id="recoveryForm">
        <div class="form-group">
          <label for="recoveryUsername">Username</label>
          <input type="text" id="recoveryUsername" placeholder="Enter your username" required>
        </div>
        <div id="securityQuestionContainer" style="display: none;">
          <div class="form-group">
            <label>Security Question:</label>
            <p id="securityQuestionText" class="security-question"></p>
            <input type="text" id="securityAnswer" placeholder="Your answer" required>
            <div id="attemptsCounter" class="attempts-counter">
              Attempts remaining: <span id="remainingAttempts">3</span>
            </div>
          </div>
        </div>
        <div id="passwordDisplay" style="display: none;">
          <div class="success-message">
            <i class="fas fa-check-circle"></i>
            <p>Your password is:</p>
            <p id="recoveredPassword"></p>
            <small>Please remember to change your password after logging in.</small>
          </div>
        </div>
        <button type="submit" class="btn">Continue</button>
      </form>
    </div>
  </div>

  <div class="toggle-container">
    <div class="toggle" id="themeToggle"></div>
  </div>

  <footer>
    <p>&copy; 2023 Flex Me. All rights reserved.</p>
  </footer>

  <script>
    class AuthenticationSystem {
      constructor() {
        this.maxLoginAttempts = 3;
        this.lockoutDuration = 15 * 60 * 1000; // 15 minutes in milliseconds
        this.initializeLoginAttempts();
      }

      initializeLoginAttempts() {
        const loginAttempts = localStorage.getItem('loginAttempts');
        if (!loginAttempts) {
          this.resetLoginAttempts();
        }
      }

      resetLoginAttempts() {
        localStorage.setItem('loginAttempts', JSON.stringify({
          count: 0,
          lastAttempt: null,
          lockedUntil: null
        }));
      }

      updateLoginAttempts(success) {
        let attempts = JSON.parse(localStorage.getItem('loginAttempts'));
        
        if (success) {
          this.resetLoginAttempts();
          return true;
        }

        attempts.count++;
        attempts.lastAttempt = new Date().getTime();

        if (attempts.count >= this.maxLoginAttempts) {
          attempts.lockedUntil = new Date().getTime() + this.lockoutDuration;
        }

        localStorage.setItem('loginAttempts', JSON.stringify(attempts));
        return false;
      }

      isAccountLocked() {
        const attempts = JSON.parse(localStorage.getItem('loginAttempts'));
        if (!attempts.lockedUntil) return false;

        const now = new Date().getTime();
        if (now < attempts.lockedUntil) {
          const remainingTime = Math.ceil((attempts.lockedUntil - now) / 1000 / 60);
          return remainingTime;
        }

        this.resetLoginAttempts();
        return false;
      }

      validateCredentials(email, password) {
        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          return { valid: false, message: 'Please enter a valid email address' };
        }

        // Password validation
        if (password.length < 8) {
          return { valid: false, message: 'Password must be at least 8 characters long' };
        }

        return { valid: true };
      }

      async login(email, password) {
        const lockoutTime = this.isAccountLocked();
        if (lockoutTime) {
          return {
            success: false,
            message: `Account is locked. Please try again in ${lockoutTime} minutes.`
          };
        }

        // Validate input
        const validation = this.validateCredentials(email, password);
        if (!validation.valid) {
          return { success: false, message: validation.message };
        }

        try {
          // Simulate API call to verify credentials
          const user = await this.verifyCredentials(email, password);
          
          if (user) {
            this.updateLoginAttempts(true);
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('userData', JSON.stringify(user));
            return { success: true, user };
          } else {
            this.updateLoginAttempts(false);
            const attempts = JSON.parse(localStorage.getItem('loginAttempts'));
            const remainingAttempts = this.maxLoginAttempts - attempts.count;
            
            return {
              success: false,
              message: `Invalid credentials. ${remainingAttempts} attempts remaining.`
            };
          }
        } catch (error) {
          return { success: false, message: 'An error occurred. Please try again.' };
        }
      }

      async verifyCredentials(email, password) {
        // This would normally be an API call to your backend
        // For demo purposes, we'll use localStorage
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.email === email);

        if (user && await this.verifyPassword(password, user.password)) {
          const { password: _, ...userWithoutPassword } = user;
          return userWithoutPassword;
        }
        return null;
      }

      async verifyPassword(inputPassword, storedPassword) {
        // In a real application, you would use proper password hashing
        // This is just for demonstration
        return inputPassword === storedPassword;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const auth = new AuthenticationSystem();
      const loginForm = document.getElementById('loginForm');
      const errorDisplay = document.getElementById('errorMessage');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');

      // Add input validation
      emailInput.addEventListener('input', function() {
        const validation = auth.validateCredentials(this.value, '12345678');
        this.setCustomValidity(validation.valid ? '' : validation.message);
      });

      passwordInput.addEventListener('input', function() {
        const validation = auth.validateCredentials('test@test.com', this.value);
        this.setCustomValidity(validation.valid ? '' : validation.message);
      });

      loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const email = emailInput.value;
        const password = passwordInput.value;

        // Show loading state
        document.querySelector('button[type="submit"]').disabled = true;
        errorDisplay.textContent = '';
        errorDisplay.style.display = 'none';

        try {
          const result = await auth.login(email, password);
          
          if (result.success) {
            // Check for return URL
            const urlParams = new URLSearchParams(window.location.search);
            const returnUrl = urlParams.get('returnUrl');
            
            // Redirect to appropriate page
            window.location.href = returnUrl || 'dashboard.html';
          } else {
            errorDisplay.textContent = result.message;
            errorDisplay.style.display = 'block';
          }
        } catch (error) {
          errorDisplay.textContent = 'An error occurred. Please try again.';
          errorDisplay.style.display = 'block';
        } finally {
          document.querySelector('button[type="submit"]').disabled = false;
        }
      });

      // Add "Show Password" functionality
      const showPasswordCheckbox = document.getElementById('showPassword');
      if (showPasswordCheckbox) {
        showPasswordCheckbox.addEventListener('change', function() {
          passwordInput.type = this.checked ? 'text' : 'password';
        });
      }

      // Add "Remember Me" functionality
      const rememberMeCheckbox = document.getElementById('rememberMe');
      if (rememberMeCheckbox) {
        // Check if there's a saved email
        const savedEmail = localStorage.getItem('rememberedEmail');
        if (savedEmail) {
          emailInput.value = savedEmail;
          rememberMeCheckbox.checked = true;
        }

        rememberMeCheckbox.addEventListener('change', function() {
          if (this.checked) {
            localStorage.setItem('rememberedEmail', emailInput.value);
          } else {
            localStorage.removeItem('rememberedEmail');
          }
        });
      }
    });

    // Keep the theme toggle code
    const toggle = document.getElementById("themeToggle");
    toggle.addEventListener("click", () => {
      document.body.classList.toggle("light-theme");
      toggle.classList.toggle("active");
    });

    // Password Recovery Modal Functions
    const modal = document.getElementById('recoveryModal');
    const closeBtn = document.querySelector('.close-modal');
    const forgotPasswordLink = document.querySelector('.forgot-password');
    const recoveryForm = document.getElementById('recoveryForm');
    const recoveryError = document.getElementById('recoveryError');
    
    // Show modal when clicking "Forgot Password"
    forgotPasswordLink.onclick = function(e) {
        e.preventDefault();
        modal.style.display = "block";
        recoveryError.style.display = 'none';
        document.getElementById('securityQuestionContainer').style.display = 'none';
        document.getElementById('passwordDisplay').style.display = 'none';
        recoveryForm.reset();
    }

    // Close modal when clicking (X) or outside
    closeBtn.onclick = closeModal;
    window.onclick = function(e) {
        if (e.target == modal) {
            closeModal();
        }
    }

    function closeModal() {
        modal.style.display = "none";
        recoveryForm.reset();
        document.getElementById('securityQuestionContainer').style.display = 'none';
        document.getElementById('passwordDisplay').style.display = 'none';
        recoveryError.style.display = 'none';
    }

    // Handle recovery form submission
    let attemptCount = 0;
    const maxAttempts = 3;
    
    recoveryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('recoveryUsername').value;
        const securityContainer = document.getElementById('securityQuestionContainer');
        const passwordDisplay = document.getElementById('passwordDisplay');
        const submitBtn = this.querySelector('button');
        const attemptsCounter = document.getElementById('attemptsCounter');
        const remainingAttempts = document.getElementById('remainingAttempts');
        
        // Get users from localStorage
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const user = users.find(u => u.username === username);

        if (!user) {
            recoveryError.textContent = 'Username not found';
            recoveryError.style.display = 'block';
            return;
        }

        if (securityContainer.style.display === 'none') {
            // Show security question
            document.getElementById('securityQuestionText').textContent = user.securityQuestion;
            securityContainer.style.display = 'block';
            recoveryError.style.display = 'none';
            submitBtn.textContent = 'Verify Answer';
            remainingAttempts.textContent = maxAttempts;
            attemptCount = 0;
        } else {
            // Verify security answer
            const answer = document.getElementById('securityAnswer').value;
            
            if (answer.toLowerCase() === user.securityAnswer.toLowerCase()) {
                securityContainer.style.display = 'none';
                document.getElementById('recoveredPassword').textContent = user.password;
                passwordDisplay.style.display = 'block';
                submitBtn.style.display = 'none';
                recoveryError.style.display = 'none';
                attemptCount = 0;
            } else {
                attemptCount++;
                const remaining = maxAttempts - attemptCount;
                remainingAttempts.textContent = remaining;
                
                if (remaining === 0) {
                    recoveryError.textContent = 'Maximum attempts reached. Please try again in 30 minutes.';
                    submitBtn.disabled = true;
                    
                    // Lock the recovery for 30 minutes
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        attemptCount = 0;
                        remainingAttempts.textContent = maxAttempts;
                        recoveryError.style.display = 'none';
                    }, 30 * 60 * 1000); // 30 minutes
                } else {
                    recoveryError.textContent = `Incorrect answer. ${remaining} attempts remaining.`;
                }
                recoveryError.style.display = 'block';
            }
        }
    });

    class PasswordRecovery {
        constructor() {
            this.maxAttempts = 3;
            this.cooldownPeriod = 30 * 60 * 1000; // 30 minutes in milliseconds
            this.initializeRecoveryAttempts();
        }

        initializeRecoveryAttempts() {
            const attempts = localStorage.getItem('recoveryAttempts');
            if (!attempts) {
                this.resetAttempts();
            }
        }

        resetAttempts() {
            localStorage.setItem('recoveryAttempts', JSON.stringify({
                count: 0,
                lastAttempt: null,
                cooldownUntil: null
            }));
        }

        isInCooldown() {
            const attempts = JSON.parse(localStorage.getItem('recoveryAttempts'));
            if (!attempts.cooldownUntil) return false;

            const now = new Date().getTime();
            if (now < attempts.cooldownUntil) {
                const remainingMinutes = Math.ceil((attempts.cooldownUntil - now) / 1000 / 60);
                return remainingMinutes;
            }

            this.resetAttempts();
            return false;
        }

        updateAttempts() {
            let attempts = JSON.parse(localStorage.getItem('recoveryAttempts'));
            attempts.count++;
            attempts.lastAttempt = new Date().getTime();

            if (attempts.count >= this.maxAttempts) {
                attempts.cooldownUntil = new Date().getTime() + this.cooldownPeriod;
            }

            localStorage.setItem('recoveryAttempts', JSON.stringify(attempts));
            return attempts;
        }

        validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async sendRecoveryEmail(email) {
            const cooldownTime = this.isInCooldown();
            if (cooldownTime) {
                return {
                    success: false,
                    message: `Too many attempts. Please try again in ${cooldownTime} minutes.`
                };
            }

            if (!this.validateEmail(email)) {
                return {
                    success: false,
                    message: 'Please enter a valid email address.'
                };
            }

            try {
                // Here you would normally make an API call to send the recovery email
                // For demo purposes, we'll simulate the API call
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userExists = users.some(u => u.email === email);

                if (!userExists) {
                    const attempts = this.updateAttempts();
                    const remainingAttempts = this.maxAttempts - attempts.count;
                    
                    return {
                        success: false,
                        message: `Email not found. ${remainingAttempts} attempts remaining.`
                    };
                }

                // Generate a recovery token (in a real app, this would be more secure)
                const token = Math.random().toString(36).substring(2, 15);
                const expiryTime = new Date().getTime() + (60 * 60 * 1000); // 1 hour expiry

                // Store the recovery token
                const recoveryTokens = JSON.parse(localStorage.getItem('recoveryTokens') || '[]');
                recoveryTokens.push({
                    email,
                    token,
                    expiryTime
                });
                localStorage.setItem('recoveryTokens', JSON.stringify(recoveryTokens));

                return {
                    success: true,
                    message: 'Recovery email sent successfully.'
                };
            } catch (error) {
                return {
                    success: false,
                    message: 'An error occurred. Please try again.'
                };
            }
        }
    }

    // Initialize Password Recovery System
    document.addEventListener('DOMContentLoaded', function() {
        const recovery = new PasswordRecovery();
        const modal = document.getElementById('recoveryModal');
        const closeBtn = document.querySelector('.close-modal');
        const recoveryForm = document.getElementById('recoveryForm');
        const recoveryError = document.getElementById('recoveryError');

        // Show modal when clicking "Forgot Password"
        document.querySelector('.forgot-password').addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'block';
            recoveryError.style.display = 'none';
            document.getElementById('securityQuestionContainer').style.display = 'none';
            document.getElementById('passwordDisplay').style.display = 'none';
            recoveryForm.reset();
        });

        // Close modal
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // Handle recovery form submission
        recoveryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('recoveryEmail').value;
            const submitBtn = this.querySelector('button[type="submit"]');

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Sending...';
            recoveryError.style.display = 'none';
            document.getElementById('passwordDisplay').style.display = 'none';

            try {
                const result = await recovery.sendRecoveryEmail(email);
                
                if (result.success) {
                    recoveryForm.style.display = 'none';
                    document.getElementById('passwordDisplay').style.display = 'block';
                    
                    // Close modal after 5 seconds
                    setTimeout(() => {
                        modal.style.display = 'none';
                        recoveryForm.style.display = 'block';
                        document.getElementById('passwordDisplay').style.display = 'none';
                        recoveryForm.reset();
                    }, 5000);
                } else {
                    recoveryError.textContent = result.message;
                    recoveryError.style.display = 'block';
                }
            } catch (error) {
                recoveryError.textContent = 'An error occurred. Please try again.';
                recoveryError.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Send Reset Link';
            }
        });

        // Add security question recovery
        const securityQuestionForm = document.getElementById('securityQuestionForm');
        if (securityQuestionForm) {
            securityQuestionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                verifySecurityAnswer();
            });
        }

        function verifySecurityAnswer() {
            const question = document.getElementById('securityQuestion').value;
            const answer = document.getElementById('securityAnswer').value.toLowerCase();
            const errorMsg = document.getElementById('answerError');
            const submitBtn = document.querySelector('.recovery-btn');

            // Get recovery attempts from localStorage
            let recoveryAttempts = JSON.parse(localStorage.getItem('recoveryAttempts') || '{"count": 0, "lockUntil": null}');
            const maxAttempts = 3;
            const cooldownPeriod = 15 * 60 * 1000; // 15 minutes in milliseconds

            // Check if account is locked
            if (recoveryAttempts.lockUntil && new Date().getTime() < recoveryAttempts.lockUntil) {
                const remainingMinutes = Math.ceil((recoveryAttempts.lockUntil - new Date().getTime()) / 1000 / 60);
                errorMsg.textContent = `Too many attempts. Please try again in ${remainingMinutes} minutes.`;
                errorMsg.style.display = "block";
                submitBtn.disabled = true;
                return;
            }

            // Reset attempts if cooldown has expired
            if (recoveryAttempts.lockUntil && new Date().getTime() >= recoveryAttempts.lockUntil) {
                recoveryAttempts = { count: 0, lockUntil: null };
            }

            // Verify answer
            if (question === userData.securityQuestion && answer === userData.securityAnswer) {
                // Reset attempts on successful recovery
                localStorage.setItem('recoveryAttempts', JSON.stringify({ count: 0, lockUntil: null }));
                
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                document.getElementById('recoveredPassword').textContent = userData.password;
                submitBtn.disabled = false;
            } else {
                // Increment attempt counter
                recoveryAttempts.count++;
                
                // Check if max attempts reached
                if (recoveryAttempts.count >= maxAttempts) {
                    recoveryAttempts.lockUntil = new Date().getTime() + cooldownPeriod;
                    errorMsg.textContent = "Too many attempts. Please try again in 15 minutes.";
                    submitBtn.disabled = true;
                } else {
                    const remainingAttempts = maxAttempts - recoveryAttempts.count;
                    errorMsg.textContent = `Incorrect answer. ${remainingAttempts} attempts remaining.`;
                    submitBtn.disabled = false;
                }

                // Save attempts to localStorage
                localStorage.setItem('recoveryAttempts', JSON.stringify(recoveryAttempts));
                errorMsg.style.display = "block";
            }
        }

        function clearForm() {
            document.getElementById('securityQuestion').value = "";
            document.getElementById('securityAnswer').value = "";
            document.getElementById('answerError').style.display = "none";
            
            // Check cooldown status when form is cleared
            const recoveryAttempts = JSON.parse(localStorage.getItem('recoveryAttempts') || '{"count": 0, "lockUntil": null}');
            const submitBtn = document.querySelector('.recovery-btn');
            
            if (recoveryAttempts.lockUntil && new Date().getTime() < recoveryAttempts.lockUntil) {
                const remainingMinutes = Math.ceil((recoveryAttempts.lockUntil - new Date().getTime()) / 1000 / 60);
                const errorMsg = document.getElementById('answerError');
                errorMsg.textContent = `Too many attempts. Please try again in ${remainingMinutes} minutes.`;
                errorMsg.style.display = "block";
                submitBtn.disabled = true;
            } else {
                submitBtn.disabled = false;
            }
        }
    });

    class LoginDataLoader {
        constructor() {
            this.initialize();
        }

        async initialize() {
            this.showLoadingState();
            try {
                await Promise.all([
                    this.checkPreviousLogin(),
                    this.loadRememberedEmail(),
                    this.loadLoginAttempts()
                ]);
                this.setupFormHandlers();
            } catch (error) {
                console.error('Error loading login data:', error);
                this.showErrorState();
            } finally {
                this.hideLoadingState();
            }
        }

        showLoadingState() {
            const container = document.querySelector('.login-container');
            if (!container) return;

            container.innerHTML = `
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading...</p>
                </div>
            `;
        }

        hideLoadingState() {
            document.querySelectorAll('.loading-spinner').forEach(spinner => spinner.remove());
        }

        showErrorState() {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading login page. Please try refreshing.</p>
                <button onclick="window.location.reload()">Refresh</button>
            `;
            document.querySelector('.login-container').prepend(errorMessage);
        }

        async checkPreviousLogin() {
            const token = localStorage.getItem('authToken');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            if (token && userData.id) {
                // Verify token validity
                if (await this.verifyToken(token)) {
                    window.location.href = 'dashboard.html';
                    return;
                } else {
                    // Clear invalid token
                    localStorage.removeItem('authToken');
                }
            }
        }

        async verifyToken(token) {
            // Simulate token verification - replace with actual API call
            return token && token.length > 0;
        }

        async loadRememberedEmail() {
            const rememberedEmail = localStorage.getItem('rememberedEmail');
            if (rememberedEmail) {
                const emailInput = document.querySelector('[name="email"]');
                const rememberMe = document.querySelector('[name="remember"]');
                if (emailInput) emailInput.value = rememberedEmail;
                if (rememberMe) rememberMe.checked = true;
            }
        }

        async loadLoginAttempts() {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
            const recentAttempts = attempts.filter(attempt => {
                const attemptTime = new Date(attempt.timestamp);
                const now = new Date();
                return now.getTime() - attemptTime.getTime() < 30 * 60 * 1000; // 30 minutes
            });

            if (recentAttempts.length >= 5) {
                this.showCaptcha();
            }

            localStorage.setItem('loginAttempts', JSON.stringify(recentAttempts));
        }

        setupFormHandlers() {
            const loginForm = document.querySelector('.login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin(e.target);
                });
            }

            // Password visibility toggle
            const togglePassword = document.querySelector('.toggle-password');
            if (togglePassword) {
                togglePassword.addEventListener('click', () => {
                    const passwordInput = document.querySelector('[name="password"]');
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    togglePassword.classList.toggle('fa-eye');
                    togglePassword.classList.toggle('fa-eye-slash');
                });
            }

            // Social login handlers
            document.querySelectorAll('.social-login-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.handleSocialLogin(btn.dataset.provider);
                });
            });

            // Forgot password handler
            const forgotPassword = document.querySelector('.forgot-password');
            if (forgotPassword) {
                forgotPassword.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showForgotPasswordModal();
                });
            }
        }

        async handleLogin(form) {
            const formData = new FormData(form);
            const email = formData.get('email');
            const password = formData.get('password');
            const remember = formData.get('remember') === 'on';

            try {
                // Validate inputs
                if (!this.validateInputs(email, password)) {
                    return;
                }

                // Check if captcha is required and verified
                if (this.isCaptchaRequired() && !this.verifyCaptcha()) {
                    this.showError('Please complete the captcha');
                    return;
                }

                // Simulate API call - replace with actual authentication
                const userData = await this.authenticateUser(email, password);
                
                if (userData) {
                    // Handle remember me
                    if (remember) {
                        localStorage.setItem('rememberedEmail', email);
                    } else {
                        localStorage.removeItem('rememberedEmail');
                    }

                    // Clear login attempts
                    localStorage.removeItem('loginAttempts');

                    // Store user data and token
                    localStorage.setItem('userData', JSON.stringify(userData));
                    localStorage.setItem('authToken', userData.token);

                    // Redirect to dashboard
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Login error:', error);
                this.recordLoginAttempt(email, false);
                this.showError('Invalid email or password');
            }
        }

        validateInputs(email, password) {
            if (!email || !email.includes('@')) {
                this.showError('Please enter a valid email address');
                return false;
            }

            if (!password || password.length < 6) {
                this.showError('Password must be at least 6 characters long');
                return false;
            }

            return true;
        }

        async authenticateUser(email, password) {
            // Simulate authentication - replace with actual API call
            if (email === 'demo@example.com' && password === 'password123') {
                return {
                    id: '12345',
                    name: 'Demo User',
                    email: email,
                    token: 'dummy-token-' + Date.now(),
                    level: 'Bronze'
                };
            }
            throw new Error('Invalid credentials');
        }

        recordLoginAttempt(email, success) {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
            attempts.push({
                email,
                success,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('loginAttempts', JSON.stringify(attempts));

            if (attempts.length >= 5) {
                this.showCaptcha();
            }
        }

        showCaptcha() {
            const captchaContainer = document.querySelector('.captcha-container');
            if (!captchaContainer) return;

            captchaContainer.innerHTML = `
                <div class="captcha">
                    <img src="data:image/svg+xml,${this.generateCaptchaImage()}" alt="CAPTCHA">
                    <input type="text" name="captcha" placeholder="Enter the code above">
                </div>
            `;
            captchaContainer.style.display = 'block';
        }

        generateCaptchaImage() {
            // Simulate captcha image generation - replace with actual captcha service
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            localStorage.setItem('captchaCode', code);
            
            // Return a simple SVG with the code
            return encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="200" height="50">
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="black">${code}</text>
                </svg>
            `);
        }

        verifyCaptcha() {
            const captchaInput = document.querySelector('[name="captcha"]');
            if (!captchaInput) return true;

            const userInput = captchaInput.value.toUpperCase();
            const correctCode = localStorage.getItem('captchaCode');
            
            return userInput === correctCode;
        }

        isCaptchaRequired() {
            const attempts = JSON.parse(localStorage.getItem('loginAttempts') || '[]');
            return attempts.length >= 5;
        }

        handleSocialLogin(provider) {
            // Simulate social login - replace with actual OAuth implementation
            console.log(`Logging in with ${provider}`);
            this.showError(`${provider} login is not implemented yet`);
        }

        showForgotPasswordModal() {
            const modal = document.createElement('div');
            modal.className = 'forgot-password-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Reset Password</h3>
                        <button onclick="this.closest('.forgot-password-modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form class="reset-password-form">
                            <div class="form-group">
                                <label for="reset-email">Email Address</label>
                                <input type="email" id="reset-email" name="email" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Reset Link</button>
                        </form>
                    </div>
                </div>
            `;

            modal.querySelector('form').addEventListener('submit', (e) => {
                e.preventDefault();
                this.handlePasswordReset(e.target);
            });

            document.body.appendChild(modal);
        }

        async handlePasswordReset(form) {
            const email = form.querySelector('[name="email"]').value;

            if (!email || !email.includes('@')) {
                this.showError('Please enter a valid email address');
                return;
            }

            // Simulate password reset - replace with actual implementation
            this.showSuccess('Password reset link has been sent to your email');
            form.closest('.forgot-password-modal').remove();
        }

        showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <p>${message}</p>
            `;
            document.querySelector('.login-container').prepend(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <p>${message}</p>
            `;
            document.querySelector('.login-container').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    }

    // Initialize login data loader when page loads
    document.addEventListener('DOMContentLoaded', () => {
        new LoginDataLoader();
    });
  </script>
</body>
</html>